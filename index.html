<!DOCTYPE html>
<html lang="fr">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
  <title>RubMaxApp</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="manifest" href="https://script.google.com/macros/s/AKfycbwoTyj8mpGYPfWCOxszGA-SPYTSBsJbJoHyFKgIr-b5xSAu-CO9pgE3bCebLGAWCVDnPg/exec?page=manifest">

  <style>
    /* Overlay loader plein √©cran */
    #page-loader {
      position: fixed;
      inset: 0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .spinner {
      width: 64px; height: 64px;
      border: 6px solid #e0e0e0;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* On cache l'app sous le loader (transition douce optionnelle) */
    #app { opacity: 0; transition: opacity .2s; }
    #app.app-ready { opacity: 1; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="page-loader"><div class="spinner"></div></div>

  <!-- Tout le contenu de la page est dans #app -->
  <div id="app">
    <!-- En-t√™te fixe -->
    <div class="fixed-header">
      <div class="logo-container" style="display: flex">
        <p style="font-weight: bold; color: blue; font-size: 20px;"><strong>RECARGA INTERNACIONAL</strong></p>
        <button id="installBtn" style="
          background-color:;
          color: white;
          padding: 2px 2px;
          font-size: 20px;
          border: none;
          border-radius: 8px;
          box-shadow: 0 0 10px rgba(0,0,0,0.2);
          z-index: 9999;
          cursor: pointer;
        ">üì≤</button>
      </div>
      <div class="nav-scroll-container" id="nav-container">
        <div id="section-nav" class="section-nav"></div>
      </div>
    </div>

    <br>

    <!-- Contenu principal -->
    <div class="container main-content">
      <div id="produits"></div>
    </div>

    <!-- Popup avec galerie d'images -->
    <div id="popup" class="popup">
      <span class="popup-close" onclick="closePopup()">&times;</span>
      <div class="gallery-container">
        <div class="image-gallery">
          <div class="gallery-images" id="gallery-images"></div>
          <div class="gallery-buttons">
            <button class="gallery-btn prev-btn" onclick="prevImage()">‚ùÆ</button>
            <button class="gallery-btn next-btn" onclick="nextImage()">‚ùØ</button>
          </div>
          <div class="gallery-dots" id="gallery-dots"></div>
        </div>
      </div>
      <div id="popup-details" class="popup-content"></div>
    </div>

    <!-- Description Popup -->
    <div id="description-popup" class="description-popup">
      <div class="description-popup-content">
        <span class="description-popup-close" onclick="closeDescriptionPopup()">&times;</span>
        <div id="description-content"></div>
      </div>
    </div>

    <!-- Pub Popup -->
    <div id="pub-popup" class="pub-popup">
      <div class="pub-content">
        <button class="pub-close" onclick="closePubPopup()">&times;</button>
        <div id="pub-container"></div>
        <div class="pub-nav-dots" id="pub-dots"></div>
      </div>
    </div>

    <!-- Pied de page -->
    <div id="ped de page">
      <div class="copyright" style="text-align: center;">
        &copy; 2020 RubMax Servicos - Todos os direitos reservados
      </div>
    </div>
    <br>

    <!-- Popup personnalis√© -->
    <div id="popup-welcome" class="popup-overlay" style="display: none;">
      <div class="popup-content">
        <span class="close-btn" onclick="document.getElementById('popup-welcome').style.display='none'">&times;</span>
        <h2>üëã TARIFA DI√ÅRIA !</h2>
        <p>Chargement...</p>
        <button class="popup-ok-btn" onclick="document.getElementById('popup-welcome').style.display='none'">OK</button>
      </div>
    </div>
  </div><!-- /#app -->

  <!-- Popup d'enregistrement -->
<div id="registrationPopup" class="popup-overlay" style="display: none;">
  <div class="popup-content">
    <div class="popup-header">
      <h3>Bienvenue chez RubMax Servicos</h3>
      <p>Veuillez vous enregistrer pour continuer</p>
    </div>
    
    <form id="registrationForm">
      <div class="form-group">
        <label for="userName">Nom complet *</label>
        <input type="text" id="userName" name="nom" required>
      </div>
      
      <div class="form-group">
        <label for="userPhone">T√©l√©phone *</label>
        <input type="tel" id="userPhone" name="telephone" required>
      </div>
      
      <div class="form-group">
        <label for="userEmail">Email *</label>
        <input type="email" id="userEmail" name="email" required>
      </div>
      
      <div class="form-buttons">
        <button type="submit" id="submitBtn" class="btn-primary">
          S'enregistrer
        </button>
      </div>
    </form>
    
    <div id="message" class="message"></div>
  </div>
</div>

<style>
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.popup-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
}

.popup-header {
  text-align: center;
  margin-bottom: 20px;
}

.popup-header h3 {
  margin: 0 0 10px 0;
  color: #333;
}

.popup-header p {
  margin: 0;
  color: #666;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.form-group input {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  box-sizing: border-box;
}

.form-buttons {
  text-align: center;
  margin-top: 20px;
}

.btn-primary {
  background: #83addc;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
}

.btn-primary:hover {
  background: #6a98c4;
}

.btn-primary:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.message {
  margin-top: 15px;
  padding: 10px;
  border-radius: 5px;
  text-align: center;
  display: none;
}

.message.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.message.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>

  <script src="script.js" defer></script>
  <script src="install.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("page-loader");
      const app = document.getElementById("app");
      const logoEl = document.getElementById("logo");

      const BASE = "https://script.google.com/macros/s/AKfycbyRHCuLb0IC_fLpQs36UW_zzgnwmDHAJtDZHByZjz3rxHieXr-Xw54yt5NvCEZgzk64xQ/exec";
      const logoUrlAPI = BASE + "?page=logo";
      const dataUrlAPI = BASE + "?page=api";

      // Utilitaires
      const fetchText = (url) => fetch(url, { cache: "no-store" }).then(r => r.text());
      const fetchJSON = (url) => fetch(url, { cache: "no-store" }).then(r => r.json());

      // Attendre que l'image soit r√©ellement charg√©e (avec fallback si url vide/erron√©e)
      const waitForImageLoad = (imgUrl, imgEl) => new Promise((resolve) => {
        if (!imgUrl) return resolve("no-url");
        const test = new Image();
        test.onload = () => { imgEl.src = imgUrl; resolve("ok"); };
        test.onerror = () => { imgEl.alt = "Logo indisponible"; resolve("error"); };
        test.src = imgUrl;
      });

      // 1) R√©cup√®re URL du logo + charge l'image
      // 2) En parall√®le, r√©cup√®re les donn√©es
      Promise.all([
        fetchText(logoUrlAPI).then(url => waitForImageLoad(url, logoEl)),
        fetchJSON(dataUrlAPI)
      ])
      .then(([logoStatus, data]) => {
        // Appelle ta fonction d‚Äôaffichage si elle existe
        if (typeof displayProducts === "function") {
          displayProducts(data);
        }
      })
      .catch(err => {
        console.error("Erreur lors du chargement :", err);
      })
      .finally(() => {
        // Retire le loader et r√©v√®le l'app quoi qu'il arrive
        loader.style.display = "none";
        app.classList.add("app-ready");
      });
    });

//===============================================================================================
//==============================================================================================





    // Configuration
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyRHCuLb0IC_fLpQs36UW_zzgnwmDHAJtDZHByZjz3rxHieXr-Xw54yt5NvCEZgzk64xQ/exec'; // REMPLACEZ PAR VOTRE URL

// V√©rifier si l'utilisateur est d√©j√† enregistr√©
function checkFirstTimeVisit() {
  const isRegistered = localStorage.getItem('rubmax_registered');
  const registrationShown = sessionStorage.getItem('registration_shown');
  
  console.log('V√©rification enregistrement:', { isRegistered, registrationShown });
  
  // Si pas encore enregistr√© ET popup pas encore affich√© dans cette session
  if (!isRegistered && !registrationShown) {
    setTimeout(() => {
      showRegistrationPopup();
    }, 1000);
    sessionStorage.setItem('registration_shown', 'true');
  }
}

// Afficher le popup d'enregistrement
function showRegistrationPopup() {
  const popup = document.getElementById('registrationPopup');
  if (popup) {
    popup.style.display = 'flex';
    console.log('Popup affich√©');
  }
}

// Cacher le popup
function hideRegistrationPopup() {
  const popup = document.getElementById('registrationPopup');
  if (popup) {
    popup.style.display = 'none';
  }
}

// Tester la connexion au script
async function testConnection() {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'test'
      })
    });
    return response.ok;
  } catch (error) {
    console.error('Test connexion √©chou√©:', error);
    return false;
  }
}

// Envoyer les donn√©es d'enregistrement
async function registerUser(userData) {
  try {
    const submitBtn = document.getElementById('submitBtn');
    const messageDiv = document.getElementById('message');
    
    // R√©initialiser le message
    messageDiv.style.display = 'none';
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enregistrement...';
    
    console.log('Envoi des donn√©es:', userData);
    
    // Ajouter userAgent pour le tracking
    userData.userAgent = navigator.userAgent;
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'register',
        ...userData
      })
    });
    
    console.log('R√©ponse re√ßue:', response);
    
    const result = await response.json();
    console.log('R√©sultat:', result);
    
    if (result.success) {
      messageDiv.textContent = result.message || 'Enregistrement r√©ussi !';
      messageDiv.className = 'message success';
      messageDiv.style.display = 'block';
      
      // Marquer comme enregistr√© dans le localStorage
      localStorage.setItem('rubmax_registered', 'true');
      
      // Cacher le popup apr√®s 2 secondes
      setTimeout(() => {
        hideRegistrationPopup();
      }, 2000);
    } else {
      messageDiv.textContent = result.message || 'Erreur lors de l\'enregistrement';
      messageDiv.className = 'message error';
      messageDiv.style.display = 'block';
    }
    
  } catch (error) {
    console.error('Erreur enregistrement:', error);
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = 'Erreur de connexion. V√©rifiez votre connexion internet.';
    messageDiv.className = 'message error';
    messageDiv.style.display = 'block';
  } finally {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'S\'enregistrer';
    }
  }
}

// √âv√©nement de soumission du formulaire
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('registrationForm');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const userData = {
        nom: formData.get('nom')?.trim(),
        telephone: formData.get('telephone')?.trim(),
        email: formData.get('email')?.trim().toLowerCase()
      };
      
      // Validation c√¥t√© client
      if (!userData.nom || !userData.telephone || !userData.email) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = 'Veuillez remplir tous les champs obligatoires';
        messageDiv.className = 'message error';
        messageDiv.style.display = 'block';
        return;
      }
      
      if (!isValidEmail(userData.email)) {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = 'Veuillez entrer un email valide';
        messageDiv.className = 'message error';
        messageDiv.style.display = 'block';
        return;
      }
      
      registerUser(userData);
    });
  }
  
  // V√©rifier au chargement de la page
  checkFirstTimeVisit();
});

// Validation email
function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}
  </script>
</body>
</html>















